---
import PageLayout from "@/layouts/Base.astro";
import { getCollection } from "astro:content";

const meta = {
	description: "æˆ‘çš„è¯»ä¹¦è®°å½•",
	title: "Books",
};

// è·å–æ‰€æœ‰ä¹¦ç±
const allBooks = await getCollection("book");

// æŒ‰çŠ¶æ€åˆ†ç»„
const readingBooks = allBooks.filter((book) => book.data.status === "reading");
const completedBooks = allBooks.filter(
	(book) => book.data.status === "completed",
);

// æŒ‰å®Œæˆæ—¶é—´æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
const sortedCompletedBooks = completedBooks.sort((a, b) => {
	const dateA = a.data.finishDate || new Date(0);
	const dateB = b.data.finishDate || new Date(0);
	return dateB.getTime() - dateA.getTime();
});

// æŒ‰å¹´ä»½åˆ†ç»„
const booksByYear = sortedCompletedBooks.reduce(
	(acc, book) => {
		const year =
			book.data.finishDate?.getFullYear() || new Date().getFullYear();
		if (!acc[year]) acc[year] = [];
		acc[year].push(book);
		return acc;
	},
	{} as Record<number, typeof sortedCompletedBooks>,
);

// ç»Ÿè®¡ä¿¡æ¯
const currentYear = new Date().getFullYear();
const currentYearCount = booksByYear[currentYear]?.length || 0;
const totalCompleted = completedBooks.length;
const currentlyReading = readingBooks.length;

// å¹´åº¦ç›®æ ‡
const yearlyGoal = 12;
const progress = Math.round((currentYearCount / yearlyGoal) * 100);

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(date: Date | undefined) {
	if (!date) return "";
	return date.toLocaleDateString("zh-CN", {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}

// ç”Ÿæˆæ˜Ÿçº§è¯„åˆ†
function generateStars(rating: number | undefined) {
	if (!rating) return "";
	return "â­".repeat(rating);
}
---

<PageLayout meta={meta}>
	<div class="prose prose-sm prose-cactus max-w-none">
		<h1 class="title mb-6">ğŸ“š è¯»ä¹¦è®°å½•</h1>

		<p class="mb-8 text-gray-600">
			è®°å½•æˆ‘è¯»è¿‡çš„ä¹¦ç±ï¼ŒåŒ…æ‹¬é˜…è¯»æ—¶é—´ã€è¯„åˆ†å’Œè¯»ä¹¦ç¬”è®°ã€‚ç‚¹å‡»ä¹¦åå¯æŸ¥çœ‹è¯¦ç»†ç¬”è®°ã€‚
		</p>

		<!-- æ­£åœ¨é˜…è¯» -->
		{
			readingBooks.length > 0 && (
				<div class="mb-8">
					<h3 class="text-lg font-semibold mb-3">ğŸ“– æ­£åœ¨é˜…è¯»</h3>
					<div class="space-y-4">
						{readingBooks.map((book) => (
							<div class="border-l-4 border-blue-500 pl-4 bg-blue-50 p-3 rounded-r">
								<div class="flex justify-between items-start mb-2">
									<h4 class="font-medium text-gray-900">
										<a
											href={`/books/${book.id}/`}
											class="hover:underline"
										>
											ã€Š{book.data.title}ã€‹
										</a>
									</h4>
									<span class="text-sm text-gray-500">
										å¼€å§‹æ—¶é—´:{" "}
										{formatDate(book.data.startDate)}
									</span>
								</div>
								<p class="text-sm text-gray-600 mb-2">
									ä½œè€…: {book.data.author}
								</p>
								{book.data.tags.length > 0 && (
									<div class="flex flex-wrap gap-1 mb-2">
										{book.data.tags.map((tag) => (
											<span class="text-xs bg-blue-200 text-blue-800 px-2 py-1 rounded">
												{tag}
											</span>
										))}
									</div>
								)}
							</div>
						))}
					</div>
				</div>
			)
		}

		<!-- æŒ‰å¹´ä»½æ˜¾ç¤ºå·²å®Œæˆçš„ä¹¦ç± -->
		{
			Object.keys(booksByYear)
				.sort((a, b) => Number(b) - Number(a))
				.map((year) => (
					<div class="mb-8">
						<h2 class="text-xl font-bold mb-4 border-b border-gray-300 pb-2">
							{year}å¹´
						</h2>
						<div class="space-y-4">
							{(booksByYear[Number(year)] || []).map((book) => (
								<div class="border-l-4 border-green-500 pl-4 bg-green-50 p-3 rounded-r">
									<div class="flex justify-between items-start mb-2">
										<h4 class="font-medium text-gray-900">
											<a
												href={`/books/${book.id}/`}
												class="hover:underline"
											>
												ã€Š{book.data.title}ã€‹
											</a>
										</h4>
										<div class="text-right">
											<div class="text-sm text-gray-500">
												{formatDate(
													book.data.finishDate,
												)}
											</div>
											{book.data.rating && (
												<div class="text-yellow-500">
													{generateStars(
														book.data.rating,
													)}
												</div>
											)}
										</div>
									</div>
									<p class="text-sm text-gray-600 mb-2">
										ä½œè€…: {book.data.author}
									</p>
									{book.data.tags.length > 0 && (
										<div class="flex flex-wrap gap-1">
											{book.data.tags.map((tag) => (
												<span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded">
													{tag}
												</span>
											))}
										</div>
									)}
								</div>
							))}
						</div>
					</div>
				))
		}

		<!-- ç»Ÿè®¡ä¿¡æ¯ -->
		<div class="mt-12 p-4 bg-gray-100 rounded-lg">
			<h3 class="text-lg font-semibold mb-3">ğŸ“Š é˜…è¯»ç»Ÿè®¡</h3>
			<div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
				<div>
					<div class="text-2xl font-bold text-blue-600">
						{currentYearCount}
					</div>
					<div class="text-sm text-gray-600">{currentYear}å¹´å·²è¯»</div>
				</div>
				<div>
					<div class="text-2xl font-bold text-green-600">
						{totalCompleted}
					</div>
					<div class="text-sm text-gray-600">æ€»è®¡å·²è¯»</div>
				</div>
				<div>
					<div class="text-2xl font-bold text-orange-600">
						{currentlyReading}
					</div>
					<div class="text-sm text-gray-600">æ­£åœ¨é˜…è¯»</div>
				</div>
				<div>
					<div class="text-2xl font-bold text-purple-600">
						{Object.keys(booksByYear).length}
					</div>
					<div class="text-sm text-gray-600">é˜…è¯»å¹´ä»½</div>
				</div>
			</div>
		</div>

		<!-- é˜…è¯»ç›®æ ‡ -->
		<div
			class="mt-8 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-400"
		>
			<h3 class="text-lg font-semibold mb-2">
				ğŸ¯ {currentYear}å¹´é˜…è¯»ç›®æ ‡
			</h3>
			<p class="text-gray-700">
				ä»Šå¹´è®¡åˆ’é˜…è¯» <strong>{yearlyGoal}</strong> æœ¬ä¹¦
			</p>
			<div class="mt-2 bg-gray-200 rounded-full h-2">
				<div
					class="bg-yellow-400 h-2 rounded-full"
					style={`width: ${progress}%`}
				>
				</div>
			</div>
			<p class="text-sm text-gray-600 mt-1">
				è¿›åº¦: {currentYearCount}/{yearlyGoal} ({progress}%)
			</p>
		</div>

		<!-- ä½¿ç”¨è¯´æ˜ -->
		<div class="mt-8 p-4 bg-blue-50 rounded-lg border border-blue-200">
			<h3 class="text-lg font-semibold mb-2">ğŸ“ å¦‚ä½•æ·»åŠ æ–°ä¹¦</h3>
			<ol
				class="text-sm text-gray-700 space-y-2 list-decimal list-inside"
			>
				<li>
					åœ¨ <code>src/content/book/</code> ç›®å½•ä¸‹åˆ›å»ºæ–°çš„ <code
						>.md</code
					> æ–‡ä»¶
				</li>
				<li>ä½¿ç”¨ frontmatter è®¾ç½®ä¹¦ç±ä¿¡æ¯ï¼ˆæ ‡é¢˜ã€ä½œè€…ã€çŠ¶æ€ç­‰ï¼‰</li>
				<li>åœ¨ Markdown æ­£æ–‡ä¸­å†™ä¸‹ä½ çš„è¯»ä¹¦ç¬”è®°å’Œæ„Ÿæƒ³</li>
				<li>ä¿å­˜æ–‡ä»¶åï¼Œé¡µé¢ä¼šè‡ªåŠ¨æ›´æ–°æ˜¾ç¤ºæ–°ä¹¦ç±</li>
			</ol>
			<p class="text-sm text-gray-600 mt-3">
				<strong>çŠ¶æ€è¯´æ˜</strong>: <code>reading</code> = æ­£åœ¨é˜…è¯», <code
					>completed</code
				> = å·²å®Œæˆ, <code>abandoned</code> = æ”¾å¼ƒé˜…è¯»
			</p>
		</div>
	</div>
</PageLayout>
