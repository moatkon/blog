---
import { getCollection, type CollectionEntry, render } from "astro:content";
import PageLayout from "@/layouts/Base.astro";

export async function getStaticPaths() {
	const books = await getCollection("book");
	return books.map((book) => ({
		params: { slug: book.id },
		props: { book },
	}));
}

interface Props {
	book: CollectionEntry<"book">;
}

const { book } = Astro.props;
const { Content } = await render(book);

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(date: Date | undefined) {
	if (!date) return "";
	return date.toLocaleDateString("zh-CN", {
		year: "numeric",
		month: "long",
		day: "numeric",
	});
}

// ç”Ÿæˆæ˜Ÿçº§è¯„åˆ†
function generateStars(rating: number | undefined) {
	if (!rating) return "";
	return "â­".repeat(rating);
}

const meta = {
	title: `ã€Š${book.data.title}ã€‹- è¯»ä¹¦ç¬”è®°`,
	description: `${book.data.author} è‘—ä½œã€Š${book.data.title}ã€‹çš„è¯»ä¹¦ç¬”è®°å’Œæ„Ÿæƒ³`,
};
---

<PageLayout meta={meta}>
	<div class="prose prose-sm prose-cactus max-w-none">
		<!-- è¿”å›é“¾æ¥ -->
		<div class="mb-6">
			<a
				href="/books/"
				class="text-sm text-global-text/70 hover:text-accent hover:underline"
			>
				â† è¿”å›è¯»ä¹¦è®°å½•
			</a>
		</div>

		<!-- ä¹¦ç±ä¿¡æ¯å¡ç‰‡ -->
		<div
			class="mb-8 p-6 bg-global-text/5 rounded-lg border border-global-text/10"
		>
			<div class="flex justify-between items-start mb-4">
				<div>
					<h1 class="text-2xl font-bold text-global-text mb-2">
						ã€Š{book.data.title}ã€‹
					</h1>
					<p class="text-lg text-global-text/80">
						ä½œè€…: {book.data.author}
					</p>
				</div>
				<div class="text-right">
					{
						book.data.status === "reading" && (
							<span class="inline-block px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-200 rounded-full text-sm">
								ğŸ“– æ­£åœ¨é˜…è¯»
							</span>
						)
					}
					{
						book.data.status === "completed" && (
							<span class="inline-block px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded-full text-sm">
								âœ… å·²å®Œæˆ
							</span>
						)
					}
					{
						book.data.status === "abandoned" && (
							<span class="inline-block px-3 py-1 bg-global-text/10 text-global-text/70 rounded-full text-sm">
								âŒ å·²æ”¾å¼ƒ
							</span>
						)
					}
				</div>
			</div>

			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
				{
					book.data.startDate && (
						<div>
							<span class="font-medium text-global-text/70">
								å¼€å§‹é˜…è¯»:
							</span>
							<span class="ml-2 text-global-text">
								{formatDate(book.data.startDate)}
							</span>
						</div>
					)
				}
				{
					book.data.finishDate && (
						<div>
							<span class="font-medium text-global-text/70">
								å®Œæˆé˜…è¯»:
							</span>
							<span class="ml-2 text-global-text">
								{formatDate(book.data.finishDate)}
							</span>
						</div>
					)
				}
				{
					book.data.publisher && (
						<div>
							<span class="font-medium text-global-text/70">
								å‡ºç‰ˆç¤¾:
							</span>
							<span class="ml-2 text-global-text">
								{book.data.publisher}
							</span>
						</div>
					)
				}
				{
					book.data.pages && (
						<div>
							<span class="font-medium text-global-text/70">
								é¡µæ•°:
							</span>
							<span class="ml-2 text-global-text">
								{book.data.pages} é¡µ
							</span>
						</div>
					)
				}
				{
					book.data.isbn && (
						<div>
							<span class="font-medium text-global-text/70">
								ISBN:
							</span>
							<span class="ml-2 text-global-text">
								{book.data.isbn}
							</span>
						</div>
					)
				}
				{
					book.data.rating && (
						<div>
							<span class="font-medium text-global-text/70">
								è¯„åˆ†:
							</span>
							<span class="ml-2 text-yellow-500 dark:text-yellow-400">
								{generateStars(book.data.rating)}
							</span>
						</div>
					)
				}
			</div>

			{
				book.data.tags.length > 0 && (
					<div class="mt-4">
						<span class="font-medium text-global-text/70 mr-2">
							æ ‡ç­¾:
						</span>
						<div class="inline-flex flex-wrap gap-1">
							{book.data.tags.map((tag) => (
								<span class="text-xs bg-global-text/10 text-global-text/80 px-2 py-1 rounded">
									{tag}
								</span>
							))}
						</div>
					</div>
				)
			}
		</div>

		<!-- è¯»ä¹¦ç¬”è®°å†…å®¹ -->
		<article class="prose prose-sm prose-cactus max-w-none">
			<Content />
		</article>

		<!-- è¿”å›é“¾æ¥ -->
		<div class="mt-12 pt-6 border-t border-global-text/20">
			<a
				href="/books/"
				class="text-sm text-global-text/70 hover:text-accent hover:underline"
			>
				â† è¿”å›è¯»ä¹¦è®°å½•
			</a>
		</div>
	</div>
</PageLayout>
